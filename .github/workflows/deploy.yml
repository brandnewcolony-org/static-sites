name: Deploy Static Sites

on:
  push:
    branches: [main]
    paths:
      - 'sites/**'

env:
  SITE_MAP: |
    uncommonthings.co.uk=uncommonthings-co-uk
    lesleytaker.co.uk=lesleytaker-co-uk

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Detect changed sites and deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          CHANGED_DIRS=$(git diff --name-only HEAD~1 HEAD -- sites/ \
            | cut -d'/' -f2 \
            | sort -u)

          if [ -z "$CHANGED_DIRS" ]; then
            echo "No site changes detected."
            exit 0
          fi

          echo "Changed sites: $CHANGED_DIRS"

          while IFS= read -r SITE_DIR; do
            PROJECT=$(echo "$SITE_MAP" | grep "^${SITE_DIR}=" | cut -d'=' -f2 | tr -d '[:space:]')

            if [ -z "$PROJECT" ]; then
              echo "No Pages project mapping for '$SITE_DIR', skipping."
              continue
            fi

            echo "Deploying $SITE_DIR -> Cloudflare Pages ($PROJECT)"
            npx wrangler pages deploy "sites/$SITE_DIR/" \
              --project-name="$PROJECT" \
              --branch=main \
              --commit-dirty=true
          done <<< "$CHANGED_DIRS"
